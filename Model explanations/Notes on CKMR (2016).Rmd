---
title: "Notes on close-kin mark-recapture"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 2
    toc_float: true
---

Bravington, Mark V., Hans J. Skaug, and Eric C. Anderson. "Close-kin mark-recapture." Statistical Science 31.2 (2016): 259-274.

# Kinship probabilities

## General notation

Let

- $z_i$ be all the information about an individual $i$, except its genotype and kinship to other individuals, that is recorded when the individual is captured
- $t_i \in z_i$, be the time of capture of an individual $i$

## Kinship probability for Mother-Offspring as expected relative reproductive output

Let

- $i$ be a female
- $j$ be an offspring
- $K_{i j}$ be the event that $i$ is the mother of $j$
- $x_j$ and $y_j$ be the place and time of $j$'s birth
- $R_i(x_j, y_j)$ be the reproductive output of $i$ at $(x_j, y_j)$, and
- $R_+(x_j, y_j)$ be the reproductive output of all adult females at $(x_j, y_j)$.

Assume that

- all offspring from the same $(x, y)$ have equal survival and sampling probabilities.

Then

$$\mathbb{P}[K_{i j} = MO|R, z_i, z_j] = \mathbb{P}[K_{i j} = MO|R] = \frac{R_i(x_j, y_j)}{R_+(x_j, y_j)}$$
and
\begin{equation}
  \mathbb{P}[K_{i j} = MO|z_i, z_j] = \mathbb{E}_{X_j, Y_j|z_j} \left[\frac{\mathbb{E}[R_i(X_j, Y_j)|z_i]} {\mathbb{E}[R_+(X_j, Y_j)]} \right].
  (\#eq:PMO)
\end{equation}
Robin's note: \@ref(eq:PMO) is not necessarily true, but requires further assumptions.
$$\mathbb{P}[K_{i j} = MO] = \mathbb{E} \left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)]}\right]$$
and
$$\mathbb{P}[K_{i j} = MO|z_i, z_j] = \mathbb{E} \left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)} |z_i, z_j \right]$$
$$= \mathbb{E}_{X_j, Y_j|z_j, z_i} \left[\mathbb{E}\left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)} |z_i\right]\right],$$
where the inner expectation integrates over the distribution of $R_i / R_+ | X_j, Y_j, z_i$,
$$= \mathbb{E}_{X_j, Y_j|z_j} \left[\mathbb{E}\left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)} |z_i\right]\right],$$
assuming $X_j$ and $Y_j$ are independent of $z_i$.  But equation \@ref(eq:PMO) requires two further steps,
\begin{equation}
  \mathbb{E}_{X_j, Y_j|z_j} \left[\mathbb{E}\left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)} |z_i\right]\right] = \mathbb{E}_{X_j, Y_j|z_j} \left[\frac{\mathbb{E}[R_i(X_j, Y_j)|z_i]} {\mathbb{E}[R_+(X_j, Y_j)|z_i]} \right],
  (\#eq:expratio)
\end{equation}
and
\begin{equation}
  \mathbb{E}_{X_j, Y_j|z_j} \left[\frac{\mathbb{E}[R_i(X_j, Y_j)|z_i]} {\mathbb{E}[R_+(X_j, Y_j)|z_i]} \right] = \mathbb{E}_{X_j, Y_j|z_j} \left[\frac{\mathbb{E}[R_i(X_j, Y_j)|z_i]} {\mathbb{E}[R_+(X_j, Y_j)]} \right],
  (\#eq:indepzi)
\end{equation}
and these are not necessarily true, but require further assumptions.

## Base case: Ages known, constant fecundity, lethal sampling, no (spatial) stock structure

Let 

- $a$ be age
- $z = (t, a)$
- $\alpha$ be age-at-maturity
- $\mathbb{I}[.]$ be the indicator function, and
- $N_{F y_j}$ be the number of mature females at time $y_j$.

Assume that

- an adult's sampling and the number of its offspring sampled are independent given covariates, or more formally
  - there are no additional covariates that affect both the probability of an adult being sampled ($p$) and its expected reproductive output $(\mathbb{E}[R_{ij}])$, and
  - there are no additional covariates that affect the sampling and/or survival probabilities of both the adult and its offspring (e.g. mother-calf pairs being caught together).

Then 

- $y = t - a$
- given that $i$ was mature, and not yet lethally sampled, at $y_j$ she is just as likely to be $j$'s mother as the other mature females at that time due to constant fecundity $\beta := \mathbb{E}[R]$, and

$$\mathbb{P}[K_{i j} = MO|z_i, z_j] = \frac{\mathbb{E}[R_i(y_j)|y_i, t_i]} {\mathbb{E}[R_+(y_j)]}$$
$$= \frac{\mathbb{I}[y_i + \alpha \le y_j < t_i]} {N_{F y_j}}$$
Robin's notes: 

- Constant fecundity $\beta := \mathbb{E}[R]$ does not imply \@ref(eq:expratio), but together they do imply these results.  That means that I can evaluate \@ref(eq:expratio) with my simulation by comparing the values of the expressions under this condition, in the non-lethal case below.
- Later they state that it is not required that all adults have the same expected reproductive output, but I do not understand what they mean.

## Non-lethal sampling

$$\mathbb{P}[K_{i j} = MO|z_i, z_j] = \frac{\mathbb{I}[y_i + \alpha \le y_j]} {N_{F y_j}} \times
\begin{cases} 
  1; & t_i > y_j, \\
  \phi(t_i, y_j); & t_i < y_j,
\end{cases}$$
where $\phi(t_i, y_j)$ is the probability that $i$ survives from $t_i$ to $y_j$.

## Age-dependent sampling and fecundity