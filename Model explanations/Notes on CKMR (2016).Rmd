---
title: "Notes on CKMR (Bravington et al., 2016)"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 2
    toc_float: true
---

# Kinship probabilities

## General notation

Let

- $z_i$ be all the information about an individual $i$, except its genotype and kinship to other individuals, that is recorded when the individual is captured
- $t_i$, in $z_i$, be the time of capture of an individual $i$

## Kinship probability for Mother-Offspring as expected relative reproductive output

Let

- $i$ be a female
- $j$ be an offspring
- $K_{i j}$ be the event that $i$ is the mother of $j$
- $x_j$ and $y_j$ be the place and time of $j$'s birth
- $R_i(x_j, y_j)$ be the reproductive output of $i$ at the place and time of $j$'s birth
- $R_+(x_j, y_j)$ be the reproductive output of all adult females at the place and time of $j$'s birth

Assume that

- all offspring from the same $(x, y)$ have equal survival and sampling probabilities

Then

$$\mathbb{P}[K_{i j} = MO|R, z_i, z_j] = \mathbb{P}[K_{i j} = MO|R] = \frac{R_i(x_j, y_j)}{R_+(x_j, y_j)}$$
$$\mathbb{P}[K_{i j} = MO] = \mathbb{E} \left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)]}\right]$$
$$\mathbb{P}[K_{i j} = MO|z_i, z_j] = \mathbb{E} \left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)]} |z_i, z_j \right]$$
$$= \mathbb{E}_{X_j, Y_j|z_j} \left[\mathbb{E}\left[\frac{R_i(X_j, Y_j)} {R_+(X_j, Y_j)} |z_i\right]\right]$$
where the inner expectation integrates over the distribution of $R_i / R_+$ at each value of $X_j, Y_j$
$$= \mathbb{E}_{X_j, Y_j|z_j} \left[\frac{\mathbb{E}[R_i(X_j, Y_j)|z_i]} {\mathbb{E}[R_+(X_j, Y_j)|z_i]} \right]$$
assuming that $R_+$ is independent of $R_i$
$$= \mathbb{E}_{X_j, Y_j|z_j} \left[\frac{\mathbb{E}[R_i(X_j, Y_j)|z_i]} {\mathbb{E}[R_+(X_j, Y_j)]} \right]$$
assuming that $R_+$ is independent of $z_i$.

The final expression above is given in the paper with the reasoning seeming to be implicit.  The assumptions do not seem to be warranted in general, as there may be strong dependencies between R_i and R_+, and R_+ and z_i.  

The assumption of constant fecundity among mature females at a given place and time, given their covariates, seems to be required.  That is, that i has the same R as all the other i's at x and y, so that R_+ = N_+ R_i, and the expected proportion E(R_i/R_+) is just E(R_i/(N_+ R_i)) = E(1/N_+) = 1/N_+ for deterministic N_+.  Otherwise R_+ could be replaced with R_z_i, representing the R of other i's in terms of i's covariates, with the assumption of constant fecundity applying within this group, and obviously retaining the dependence on z_i.  Is this what they're actually doing?

What I'm doing is assuming a constant Bernoulli distribution for females, and a different constant distribution of R for males.  This gives exactly the same result as above, with the same reasoning, as constant fecundity is just a particular case of it.  

For non-deterministic N_+ it's still wrong though, and I take this into account.  I should keep reading their later cases and check that this is actually what they're doing.   

## Base case: Ages known, constant fecundity, lethal sampling, no (spatial) stock structure

Let 

- $a$ be age
- $\alpha$ be age-at-maturity
- $\mathbb{I}[.]$ be the indicator function
- $N_{F y_j}$ be the number of mature females at time $y_j$

Assume that

- an adult's sampling and the number of its offspring sampled are independent given covariates, or more formally
  - there are no additional covariates that affect both the probability of an adult being sampled ($p$) and its expected reproductive output at $y_j$ ($R_{ij}$)
  - there are no additional covariates that affect the sampling and/or survival probabilities of both the adult and its offspring (e.g. If mother-calf pairs are caught together)

Then 

- $y = t - a$
- given that $i$ was mature and not yet lethally sampled at $y_j$ she is just as likely to be $j$'s mother as the other mature females at that time

$$\mathbb{P}[K_{i j} = MO|z_i, z_j] = \frac{\mathbb{E}[R_i(y_j)|y_i, t_i]} {\mathbb{E}[R_+(y_j)]}$$
$$= \frac{\mathbb{I}[y_i + \alpha \le y_j < t_i]} {N_{F y_j}}$$

## Non-lethal sampling

$$\mathbb{P}[K_{i j} = MO|z_i, z_j] = \frac{\mathbb{I}[y_i + \alpha \le y_j]} {N_{F y_j}} \times
\begin{cases} 
  1; & t_i > y_j, \\
  \phi(t_i, y_j); & t_i < y_j,
\end{cases}$$
where $\phi(t_i, y_j)$ is the probability that $i$ survives from $t_i$ to $y_j$.

## Age-dependent sampling and fecundity